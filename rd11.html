<!DOCTYPE html>
<html lang="" xml:lang="">
  <head>
    <title>11. (Panel) Matching</title>
    <meta charset="utf-8" />
    <meta name="date" content="2023-11-16" />
    <script src="libs/header-attrs/header-attrs.js"></script>
    <link rel="stylesheet" href="xaringan-themer.css" type="text/css" />
  </head>
  <body>
    <textarea id="source">
class: middle, center, title-slide

.title[
# 11. (Panel) Matching
]
.date[
### 16 November 2023
]

---









### Matching Basics

- Individual treatment effect for **treated** observation *i* = `\(Y_i(1) - Y_i(0)\)`

- `\(Y_i(1)\)` is observed, but `\(Y_i(0)\)` is not 

- Estimate `\(Y_i(0)\)` with a **matched control** `\(Y_j\)`, where:

  - `\(Y_j(0)\)` is observed
  
  - `\(X_i \approx X_j\)` for all potential confounders `\(X\)`

--

&lt;br&gt; 

- Quantity of interest is **not** the ATE (no claims about random assignment), but rather the (feasible) sample ATT  

--

  - "Feasible" because we "throw away" not only unmatched control units, but also unmatched treated units

---

### Why Match? Some Graphical Intuition

.pull-left[

- Suppose we wanted to estimate the effect of .orange[T] vs .blue[C] on some outcome, controlling for education 

]


.pull-right[

&lt;img src="https://nanzhangresearch.github.io/rdgraphics/hoking1.png" width="600px" /&gt;
Ho et al. (2007)
]

---

### Why Match? Some Graphical Intuition

.pull-left[

- Suppose we wanted to estimate the effect of .orange[T] vs .blue[C] on some outcome, controlling for education 

- Estimate a model:

$$
Y = \alpha + \beta_1 \, T + \beta_2 \, Educ + \epsilon
$$ 

]


.pull-right[

&lt;img src="https://nanzhangresearch.github.io/rdgraphics/hoking2.png" width="600px" /&gt;
Ho et al. (2007)
]


---

### Why Match? Some Graphical Intuition

.pull-left[

- Suppose we wanted to estimate the effect of .orange[T] vs .blue[C] on some outcome, controlling for education 

- Maybe better? : 

$$
Y = \alpha + \beta_1 \, T + \beta_2 \, Educ + \beta_3 \, Educ^2 + \epsilon
$$ 

]


.pull-right[

&lt;img src="https://nanzhangresearch.github.io/rdgraphics/hoking3.png" width="600px" /&gt;
Ho et al. (2007)
]


---

### Why Match? Some Graphical Intuition

.pull-left[

- Suppose we wanted to estimate the effect of .orange[T] vs .blue[C] on some outcome, controlling for education 

- Our estimate of `\(\beta_2\)` is **model dependent**

- And model dependency arises because of **imbalance** between .orange[T] and .blue[C] units on education
]


.pull-right[

&lt;img src="https://nanzhangresearch.github.io/rdgraphics/hoking3.png" width="600px" /&gt;
Ho et al. (2007)
]


---

### Why Match? Some Graphical Intuition

.pull-left[

- Suppose we wanted to estimate the effect of .orange[T] vs .blue[C] on some outcome, controlling for education 

- Our estimate of `\(\beta_2\)` is **model dependent**

- And model dependency arises because of **imbalance** between .orange[T] and .blue[C] units on education

- Let's prune away the unmatched units.
]


.pull-right[

&lt;img src="https://nanzhangresearch.github.io/rdgraphics/hoking4.png" width="600px" /&gt;
Ho et al. (2007)
]

---

### Why Match? Some Graphical Intuition

.pull-left[

- Suppose we wanted to estimate the effect of .orange[T] vs .blue[C] on some outcome, controlling for education 

- Our estimate of `\(\beta_2\)` is **model dependent**

- And model dependency arises because of **imbalance** between .orange[T] and .blue[C] units on education

- Let's prune away the unmatched units.

- And now fit the models.
]


.pull-right[

&lt;img src="https://nanzhangresearch.github.io/rdgraphics/hoking5.png" width="600px" /&gt;
Ho et al. (2007)
]

--

&lt;br&gt;

- Reducing model dependency also reduces **researcher degrees of freedom**.


---

### Relationship to Multiverse Analysis

.center[
&lt;img src="https://nanzhangresearch.github.io/rdgraphics/spec_curve.png" width="800px" /&gt;
]
Simonsohn et al. (2020)


---

### Relationship to Multiverse Analysis

.center[
&lt;img src="https://nanzhangresearch.github.io/rdgraphics/king_histograms.png" width="800px" /&gt;
]
Ho et al. (2007)


---

### Coarsened Exact Matching (CEM)

- Similar to a fully blocked design:

  - Define blocks based on combinations of covariates 
  
  - Cell =  age `\(\times\)` gender `\(\times\)` years of education
  
  - Make sure there exist .orange[T] and .blue[C] units within each cell

--

&lt;br&gt;

- Curse of dimensionality: with lots of (finely-graded) covariates, few cells contain **common support** (i.e. both .orange[T] and .blue[C] exist)

--

- Solution: exact matching based on temporarily bin (coarsen) the cells !

  - Age `\(\rightarrow\)` age categories (18-29, 30-45, etc.)
  
  - Years of education `\(\rightarrow\)` highest education level (No highschool, HS grad, BA, etc.)
  
---
### CEM: Graphical Illustration

.pull-left[
&lt;img src="https://nanzhangresearch.github.io/rdgraphics/king_cem1.png" width="500px" /&gt;

From Gary King's Youtube Lecture
]

.pull-right[
- Suppose we want to match on age and education

]


---
### CEM: Graphical Illustration

.pull-left[
&lt;img src="https://nanzhangresearch.github.io/rdgraphics/king_cem2.png" width="500px" /&gt;

From Gary King's Youtube Lecture
]

.pull-right[
- Suppose we want to match on age and education

- Coarsen the variables
]

---
### CEM: Graphical Illustration

.pull-left[
&lt;img src="https://nanzhangresearch.github.io/rdgraphics/king_cem3.png" width="500px" /&gt;

From Gary King's Youtube Lecture
]

.pull-right[
- Suppose we want to match on age and education

- Coarsen the variables

- Create cells
]

---
### CEM: Graphical Illustration

.pull-left[
&lt;img src="https://nanzhangresearch.github.io/rdgraphics/king_cem4.png" width="500px" /&gt;

From Gary King's Youtube Lecture
]

.pull-right[
- Suppose we want to match on age and education

- Coarsen the variables

- Create cells

- Drop unmatched observations
]

---
### CEM: Graphical Illustration

.pull-left[
&lt;img src="https://nanzhangresearch.github.io/rdgraphics/king_cem5.png" width="500px" /&gt;

From Gary King's Youtube Lecture
]

.pull-right[
- Suppose we want to match on age and education

- Coarsen the variables

- Create cells

- Drop unmatched observations

- Weight the data
]


---
### CEM: Graphical Illustration

.pull-left[
&lt;img src="https://nanzhangresearch.github.io/rdgraphics/king_cem6.png" width="500px" /&gt;

From Gary King's Youtube Lecture
]

.pull-right[
- Suppose we want to match on age and education

- Coarsen the variables

- Create cells

- Drop unmatched observations

- Weight the data

- Calculate a weighted diff-in-means 

- Or estimate a weighted model (with un-coarsened Xs)
]


---

### Mahalanobis Distance Matching

Basic idea: calculate the (standardized) Euclidean distance between units


.pull-left[

Match each .orange[T] to the nearest .blue[C] with replacement:

&lt;img src="https://nanzhangresearch.github.io/rdgraphics/bauermatch1.png" width="600px" /&gt;

or without replacement:

&lt;img src="https://nanzhangresearch.github.io/rdgraphics/bauermatch2.png" width="600px" /&gt;
]


--

.pull-right[

- In case of 1:m (or m:1) matches, use weights

- Could also define a **caliper** (or max distance) such that large distances are no longer matched.

]

---

### Considerations

- Unlike CEM, we are reducing multiple dimensions to a distance scalar

- But are we just combining apples and oranges?  Consider:

  - Unit A: income = 35.000 ,  education = 12 years
  
  - Unit B: income = 60.000,  education = 13 years
  
  - Unit C: income = 45.000,  education = 16 years
  
- How much income is **substantively** equivalent to 1 year of education?  

- Dividing by the standard deviation of X is both **atheoretical** and **sample dependent**

--

&lt;br&gt;

- Gary King's suggestion: you pick the "exchange rate" yourself based on substantive knowledge


---

### Propensity Score Matching (PSM)

- Instead of Mahalanobis distance, you could instead match on a **propensity score** `\(T_i\)`

  - `\(T_i\)` = probability of receiving treatment conditional on the covariates `\(X\)`

  - Estimate a logistic regression of `\(T\)` on `\(X\)` and predict `\(\hat{T}\)`
  
  - Calculate a propensity score distance = `\(|\widehat{T_c}\)` - `\(\widehat{T_t}|\)`

  - Match each .orange[T] to the nearest .blue[C] within a caliper (dropping non-matches) 

---

### PSM Graphical Intuition

.pull-left[

- Rather than matching directly on age and education, use both to predict the probability of treatment

]


.pull-right[

&lt;img src="https://nanzhangresearch.github.io/rdgraphics/king_psm1.png" width="600px" /&gt;

From Gary King's Youtube Lecture
]

---

### PSM Graphical Intuition

.pull-left[

- Rather than matching directly on age and education, use both to predict the probability of treatment


]


.pull-right[

&lt;img src="https://nanzhangresearch.github.io/rdgraphics/king_psm2.png" width="600px" /&gt;

From Gary King's Youtube Lecture
]


---

### PSM Graphical Intuition

.pull-left[

- Rather than matching directly on age and education, use both to predict the probability of treatment

- Conduct matches based on the propensity scores

]


.pull-right[

&lt;img src="https://nanzhangresearch.github.io/rdgraphics/king_psm3.png" width="600px" /&gt;

From Gary King's Youtube Lecture
]

---

### PSM Graphical Intuition

.pull-left[

- Rather than matching directly on age and education, use both to predict the probability of treatment

- Conduct matches based on the propensity scores

- Drop unmatched observations

]


.pull-right[

&lt;img src="https://nanzhangresearch.github.io/rdgraphics/king_psm4.png" width="600px" /&gt;

From Gary King's Youtube Lecture
]

---

### PSM Graphical Intuition

.pull-left[

- Rather than matching directly on age and education, use both to predict the probability of treatment

- Conduct matches based on the propensity scores

- Drop unmatched observations

- Conduct analysis on resulting matches

]


.pull-right[

&lt;img src="https://nanzhangresearch.github.io/rdgraphics/king_psm5.png" width="600px" /&gt;

From Gary King's Youtube Lecture
]




---

### PSM Problems

.fnsize[
- Idea (hope) behind the logit: `\(\beta\)`s identify the Xs that distinguish between treatment and control

- But X which are very predictive of T might not be very predictive of Y...

- ...and units with similar propensity scores could have very different X values!
]

--

.center[
&lt;img src="https://nanzhangresearch.github.io/rdgraphics/king_nielsen.png" width="800px" /&gt;
]
.small[King and Nielsen 2019]

---

### A Pathological Example

.center[

&lt;img src="https://nanzhangresearch.github.io/rdgraphics/king_psm6.png" width="600px" /&gt;

From Gary King's Youtube Lecture
]


---

### A Pathological Example

.center[

&lt;img src="https://nanzhangresearch.github.io/rdgraphics/king_psm7.png" width="600px" /&gt;

From Gary King's Youtube Lecture
]

---

### A Pathological Example

.pull-left[

&lt;img src="https://nanzhangresearch.github.io/rdgraphics/king_psm8.png" width="400px" /&gt;

From Gary King's Youtube Lecture
]

.pull-right[

&lt;br&gt;

- Since all propensity scores are identical, 1-1 (or 1-m) matching creates matches **randomly**

- Here, using PSM has **increased imbalance**

- Gary King's advice: don't use PSM!

]

---

### Matching in a Panel Context

- We often analyze panel data using 2-way fixed effects models

- These models "subtract out":

  - the average `\(Y_i\)` across all periods `\(t\)`

  - the average `\(Y_t\)` across all units `\(i\)`
  
- We therefore control for all unit-invariant and period-invariant effects, and focus instead on the "effects" of factors which change *within units* over time.

--

&lt;br&gt;

- TWFE models are increasingly recognized as problematic for a variety of reasons

- Main idea for our purposes: **the counterfactual is unclear**


---

### Panel Match

.pull-left[

- For each treated observation, select a set of control observations from other units in the same time period that have an identical treatment history for a prespecified time span.

- Refine this set using Mahalanobis, PSM, or IPW so that matched control observations become similar to the treated observation in terms of covariate histories. 

- Apply a difference-in-differences (DiD) estimator that adjusts for a possible time trend.


]

.pull-right[
&lt;img src="https://nanzhangresearch.github.io/rdgraphics/imai_att.png" width="500px" /&gt;
]


---

### Application: Traffic Stops and Voting

- Data: all traffic stops in Hillsborough County, FL merged to the registered voter file

- Approx. 2,3 million observations

- How are treatment and control groups defined (see p.826)?

  - e.g. **who is the counterfactual for a voter stopped between 2012 and 2014?** (and whose DV =  turnout in 2014)
  

--

- Are you convinced:

  - "*after controlling for observable characteristics, past turnout, and the unobservable characteristics associated with experiencing a traffic stop, the **timing of the stop is effectively random***" ?


---

### Application: Traffic Stops and Voting

.pull-left[

&lt;img src="https://nanzhangresearch.github.io/rdgraphics/traffic_table1.png" width="400px" /&gt;

]

--

.pull-right[

&lt;img src="https://nanzhangresearch.github.io/rdgraphics/traffic_fig2.png" width="500px" /&gt;

]

---

### Results Disaggregated

.center[
&lt;img src="https://nanzhangresearch.github.io/rdgraphics/traffic_fig2.png" width="500px" /&gt;
]


---

### Application: War and Inheritance Taxes

.pull-left[
&lt;img src="https://nanzhangresearch.github.io/rdgraphics/imai_screedplot.png" width="480px" /&gt;
]

.pull-right[

Number of matched control units:

&lt;img src="https://nanzhangresearch.github.io/rdgraphics/imai_histograms.png" width="5000px" /&gt;
]

---

### Application: War and Inheritance Taxes


.pull-left[
&lt;img src="https://nanzhangresearch.github.io/rdgraphics/imai_matches.png" width="500px" /&gt;
]

.pull-right[

Covariates for matching: 

- leftist executive

- universal male suffrage

- logged real GDP per capita.

And also the lagged outcome variable.

]

---

### Application: War and Inheritance Taxes

.center[
&lt;img src="https://nanzhangresearch.github.io/rdgraphics/imai_resuts.png" width="700px" /&gt;
]

---

### Advice on Presentations:

- You will have 30-40 minutes.  Save about half your time for Q&amp;A.

- Succinctly motivate and state the research question in the first slide.  No long lit reviews!

- Provide enough details on the data (either existing datasets, or data that you plan to collect) so that we can follow along.

- Focus on the research design, the planned analyses, and the assumptions that you will need to identify causal effects.

- Please come see us in office hours if you have questions.

    </textarea>
<style data-target="print-only">@media screen {.remark-slide-container{display:block;}.remark-slide-scaler{box-shadow:none;}}</style>
<script src="https://remarkjs.com/downloads/remark-latest.min.js"></script>
<script>var slideshow = remark.create({
"highlightStyle": "github",
"highlightLines": true,
"countIncrementalSlides": false,
"ratio": "14:9"
});
if (window.HTMLWidgets) slideshow.on('afterShowSlide', function (slide) {
  window.dispatchEvent(new Event('resize'));
});
(function(d) {
  var s = d.createElement("style"), r = d.querySelector(".remark-slide-scaler");
  if (!r) return;
  s.type = "text/css"; s.innerHTML = "@page {size: " + r.style.width + " " + r.style.height +"; }";
  d.head.appendChild(s);
})(document);

(function(d) {
  var el = d.getElementsByClassName("remark-slides-area");
  if (!el) return;
  var slide, slides = slideshow.getSlides(), els = el[0].children;
  for (var i = 1; i < slides.length; i++) {
    slide = slides[i];
    if (slide.properties.continued === "true" || slide.properties.count === "false") {
      els[i - 1].className += ' has-continuation';
    }
  }
  var s = d.createElement("style");
  s.type = "text/css"; s.innerHTML = "@media print { .has-continuation { display: none; } }";
  d.head.appendChild(s);
})(document);
// delete the temporary CSS (for displaying all slides initially) when the user
// starts to view slides
(function() {
  var deleted = false;
  slideshow.on('beforeShowSlide', function(slide) {
    if (deleted) return;
    var sheets = document.styleSheets, node;
    for (var i = 0; i < sheets.length; i++) {
      node = sheets[i].ownerNode;
      if (node.dataset["target"] !== "print-only") continue;
      node.parentNode.removeChild(node);
    }
    deleted = true;
  });
})();
// add `data-at-shortcutkeys` attribute to <body> to resolve conflicts with JAWS
// screen reader (see PR #262)
(function(d) {
  let res = {};
  d.querySelectorAll('.remark-help-content table tr').forEach(tr => {
    const t = tr.querySelector('td:nth-child(2)').innerText;
    tr.querySelectorAll('td:first-child .key').forEach(key => {
      const k = key.innerText;
      if (/^[a-z]$/.test(k)) res[k] = t;  // must be a single letter (key)
    });
  });
  d.body.setAttribute('data-at-shortcutkeys', JSON.stringify(res));
})(document);
(function() {
  "use strict"
  // Replace <script> tags in slides area to make them executable
  var scripts = document.querySelectorAll(
    '.remark-slides-area .remark-slide-container script'
  );
  if (!scripts.length) return;
  for (var i = 0; i < scripts.length; i++) {
    var s = document.createElement('script');
    var code = document.createTextNode(scripts[i].textContent);
    s.appendChild(code);
    var scriptAttrs = scripts[i].attributes;
    for (var j = 0; j < scriptAttrs.length; j++) {
      s.setAttribute(scriptAttrs[j].name, scriptAttrs[j].value);
    }
    scripts[i].parentElement.replaceChild(s, scripts[i]);
  }
})();
(function() {
  var links = document.getElementsByTagName('a');
  for (var i = 0; i < links.length; i++) {
    if (/^(https?:)?\/\//.test(links[i].getAttribute('href'))) {
      links[i].target = '_blank';
    }
  }
})();
// adds .remark-code-has-line-highlighted class to <pre> parent elements
// of code chunks containing highlighted lines with class .remark-code-line-highlighted
(function(d) {
  const hlines = d.querySelectorAll('.remark-code-line-highlighted');
  const preParents = [];
  const findPreParent = function(line, p = 0) {
    if (p > 1) return null; // traverse up no further than grandparent
    const el = line.parentElement;
    return el.tagName === "PRE" ? el : findPreParent(el, ++p);
  };

  for (let line of hlines) {
    let pre = findPreParent(line);
    if (pre && !preParents.includes(pre)) preParents.push(pre);
  }
  preParents.forEach(p => p.classList.add("remark-code-has-line-highlighted"));
})(document);</script>

<script>
slideshow._releaseMath = function(el) {
  var i, text, code, codes = el.getElementsByTagName('code');
  for (i = 0; i < codes.length;) {
    code = codes[i];
    if (code.parentNode.tagName !== 'PRE' && code.childElementCount === 0) {
      text = code.textContent;
      if (/^\\\((.|\s)+\\\)$/.test(text) || /^\\\[(.|\s)+\\\]$/.test(text) ||
          /^\$\$(.|\s)+\$\$$/.test(text) ||
          /^\\begin\{([^}]+)\}(.|\s)+\\end\{[^}]+\}$/.test(text)) {
        code.outerHTML = code.innerHTML;  // remove <code></code>
        continue;
      }
    }
    i++;
  }
};
slideshow._releaseMath(document);
</script>
<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
(function () {
  var script = document.createElement('script');
  script.type = 'text/javascript';
  script.src  = 'https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML';
  if (location.protocol !== 'file:' && /^https?:/.test(script.src))
    script.src  = script.src.replace(/^https?:/, '');
  document.getElementsByTagName('head')[0].appendChild(script);
})();
</script>
  </body>
</html>
